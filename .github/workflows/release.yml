name: Create Release

on:
  workflow_dispatch:
    inputs:
      tagname:
        description: "Release tag name"
        type: string
        required: true
      linux_run_id:
        description: "Linux build workflow run ID"
        type: string
        required: true
      windows_run_id:
        description: "Windows build workflow run ID"
        type: string
        required: true
  workflow_call:
    inputs:
      tagname:
        description: "Release tag name"
        type: string
        required: true
      linux_run_id:
        description: "Linux build workflow run ID"
        type: string
        required: true
      windows_run_id:
        description: "Windows build workflow run ID"
        type: string
        required: true

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            changelog.txt

      - name: Download Linux artifact
        uses: actions/download-artifact@v7
        with:
          name: fagram-${{ inputs.tagname }}
          path: artifacts/linux
          github-token: ${{ secrets.PAT }}
          run-id: ${{ inputs.linux_run_id }}

      - name: Download Windows portable artifact
        uses: actions/download-artifact@v7
        with:
          name: FAgram_Win-x64
          path: artifacts/windows
          github-token: ${{ secrets.PAT }}
          run-id: ${{ inputs.windows_run_id }}

      - name: Download Windows installer artifact
        uses: actions/download-artifact@v7
        with:
          name: FAgram_Win-x64_installer
          path: artifacts/windows-installer
          github-token: ${{ secrets.PAT }}
          run-id: ${{ inputs.windows_run_id }}

      - name: List downloaded artifacts
        run: |
          echo "=== Linux artifacts ==="
          ls -la artifacts/linux/
          echo "=== Windows artifacts ==="
          ls -la artifacts/windows/
          echo "=== Windows installer artifacts ==="
          ls -la artifacts/windows-installer/

      - name: Extract changelog for release
        run: |
          # Extract changes for the current version from changelog.txt
          awk '/^[0-9]+\.[0-9]+\.[0-9]+ \([0-9]{2}\.[0-9]{2}\.[0-9]{2}\)/ {
            if (found) exit;
            if ($1 == "${{ inputs.tagname }}") {
              found=1;
              next;
            }
          }
          found && /^-/ { print; }
          found && /^â€”/ { print; }' changelog.txt > body.txt

          echo "Release body:"
          cat body.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tagname }}
          name: FAgram ${{ inputs.tagname }}
          draft: false
          prerelease: false
          body_path: body.txt
          files: |
            artifacts/linux/fagram-${{ inputs.tagname }}.tar.gz
            artifacts/windows/FAgram_Win-x64_${{ inputs.tagname }}_portable.zip
            artifacts/windows-installer/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}

  trigger-rpm:
    name: Trigger RPM Build
    runs-on: ubuntu-latest
    needs: create-release
    steps:
      - name: Trigger repository dispatch event
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.PAT }}
          repository: fagramdesktop/fagram-rpm
          event-type: new-release

  update-scoop:
    name: Update Scoop Manifest
    needs: create-release
    uses: ./.github/workflows/scoop-manifest.yml
    with:
      release_tag: ${{ inputs.tagname }}
    secrets: inherit
