name: Upload to Telegram

on:
  workflow_call:
    inputs:
      tagname:
        description: "Release tag name"
        type: string
        required: true
      run_id:
        description: "Workflow run ID to download artifacts from"
        type: string
        required: true
      build_type:
        description: "Build type (ci or rel)"
        type: string
        required: true

jobs:
  upload:
    name: Upload Artifacts to Telegram
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            scripts/tgupload.py
            Telegram/SourceFiles/fa/fa_version.h

      - name: Extract TGD version
        id: tgd_version
        run: |
          TGD_VERSION=$(grep 'AppTGDVersion' Telegram/SourceFiles/fa/fa_version.h | sed 's/.*"\(.*\)".*/\1/')
          echo "TGD_VERSION=$TGD_VERSION" >> $GITHUB_ENV

      - name: Generate changelog
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          REPO="${{ github.repository }}"
          HEAD_SHA="${{ github.sha }}"
          BRANCH="${{ github.ref_name }}"

          if [ "${{ inputs.build_type }}" = "rel" ]; then
            TAGS=$(curl -s -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/tags?per_page=10" | jq -r '.[].name')
            PREV_TAG=$(echo "$TAGS" | grep -v "^${{ inputs.tagname }}$" | head -1)
            if [ -n "$PREV_TAG" ]; then
              COMPARE=$(curl -s -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/compare/$PREV_TAG...$HEAD_SHA")
              CHANGELOG=$(echo "$COMPARE" | jq -r '[.commits[].commit.message | split("\n")[0]] | map("• " + .) | join("\n")')
            fi
          else
            LAST_SHA=$(curl -s -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/actions/runs?status=completed&conclusion=success&branch=$BRANCH&per_page=2" \
              | jq -r '[.workflow_runs[] | select(.head_sha != "'"$HEAD_SHA"'")][0].head_sha // empty')
            if [ -n "$LAST_SHA" ]; then
              COMPARE=$(curl -s -H "Accept: application/vnd.github+json" \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/compare/$LAST_SHA...$HEAD_SHA")
              CHANGELOG=$(echo "$COMPARE" | jq -r '[.commits[].commit.message | split("\n")[0]] | map("• " + .) | join("\n")')
            fi
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="No new changes"
          fi
          CHANGELOG=$(echo "$CHANGELOG" | head -15)
          echo "CHANGELOG<<CHANGELOG_EOF" >> $GITHUB_ENV
          echo "$CHANGELOG" >> $GITHUB_ENV
          echo "CHANGELOG_EOF" >> $GITHUB_ENV

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyrofork tgcrypto

      - name: Download Linux artifact
        uses: actions/download-artifact@v7
        with:
          name: fagram-${{ inputs.tagname }}
          path: artifacts/linux
          github-token: ${{ secrets.PAT }}
          run-id: ${{ inputs.run_id }}

      - name: Download Windows portable artifact
        uses: actions/download-artifact@v7
        with:
          name: FAgram_Win-x64
          path: artifacts/windows
          github-token: ${{ secrets.PAT }}
          run-id: ${{ inputs.run_id }}

      - name: Download Windows installer artifact
        uses: actions/download-artifact@v7
        with:
          name: FAgram_Win-x64_installer
          path: artifacts/windows-installer
          github-token: ${{ secrets.PAT }}
          run-id: ${{ inputs.run_id }}

      - name: List artifacts
        run: |
          echo "=== Linux artifacts ==="
          ls -la artifacts/linux/
          echo "=== Windows artifacts ==="
          ls -la artifacts/windows/
          echo "=== Windows installer artifacts ==="
          ls -la artifacts/windows-installer/

      - name: Upload Linux artifact to Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          API_ID: ${{ secrets.API_ID_CONFIG }}
          API_HASH: ${{ secrets.API_HASH_CONFIG }}
        run: |
          LINUX_FILE=$(find artifacts/linux -name "fagram-*.tar.gz" | head -1)
          python3 scripts/tgupload.py "$LINUX_FILE" --chat-id ${{ secrets.CHAT_ID }} --caption "$(cat <<EOF
          <b>FAgram Linux ${{ inputs.tagname }}</b>
          TGD Base: <code>${{ env.TGD_VERSION }}</code>
          Build Type: <code>${{ inputs.build_type }}</code>
          Branch: <code>${{ github.ref_name }}</code>

          <blockquote expandable>${{ env.CHANGELOG }}</blockquote>
          EOF
          )"

      - name: Upload Windows builds to Telegram
        env:
          BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
          API_ID: ${{ secrets.API_ID_CONFIG }}
          API_HASH: ${{ secrets.API_HASH_CONFIG }}
        run: |
          WIN_PORTABLE=$(find artifacts/windows -name "FAgram_Win-x64_*_portable.zip" | head -1)
          WIN_INSTALLER=$(find artifacts/windows-installer -name "fagram-setup_Win-x64.*.exe" | head -1)
          python3 scripts/tgupload.py --files "$WIN_PORTABLE" "$WIN_INSTALLER" --chat-id ${{ secrets.CHAT_ID }} --caption "$(cat <<EOF
          <b>FAgram Windows x64 ${{ inputs.tagname }}</b>
          TGD Base: <code>${{ env.TGD_VERSION }}</code>
          Build Type: <code>${{ inputs.build_type }}</code>
          Branch: <code>${{ github.ref_name }}</code>

          <blockquote expandable>${{ env.CHANGELOG }}</blockquote>
          EOF
          )"
