name: Update Scoop Manifest

on:
  workflow_call:
    inputs:
      release_tag:
        description: 'Release tag to update manifest for'
        type: string
        required: true
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to update manifest for'
        type: string
        required: true

jobs:
  update-manifest:
    name: Update Scoop Manifest
    runs-on: ubuntu-latest
    
    steps:
      - name: Clone scoop manifest repository
        uses: actions/checkout@v6
        with:
          repository: burhancodes/fagram-scoop
          token: ${{ secrets.PAT }}
          path: fagram-scoop
          
      - name: Get release tag
        id: get_tag
        run: |
          echo "RELEASE_TAG=${{ inputs.release_tag }}" >> $GITHUB_ENV
          
      - name: Download release asset
        run: |
          ASSET_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/FAgram_Win-x64_${RELEASE_TAG}_portable.zip"
          echo "Downloading from: $ASSET_URL"
          curl -L -o FAgram_portable.zip "$ASSET_URL"
          
      - name: Calculate hash and update manifest
        run: |
          HASH=$(sha256sum FAgram_portable.zip | awk '{print $1}')
          echo "Hash: $HASH"
          echo "Version: $RELEASE_TAG"
          
          cd fagram-scoop
          sed -i "s/\"version\": \".*\"/\"version\": \"$RELEASE_TAG\"/" fagram.json
          sed -i "s/\"hash\": \".*\"/\"hash\": \"$HASH\"/" fagram.json
          sed -i "s|releases/download/[0-9.]\+/|releases/download/$RELEASE_TAG/|g" fagram.json
          sed -i "s/FAgram_Win-x64_[0-9.]\+_portable\.zip/FAgram_Win-x64_${RELEASE_TAG}_portable.zip/g" fagram.json
          
          echo "Updated fagram.json:"
          cat fagram.json
          
      - name: Commit and push changes
        run: |
          cd fagram-scoop
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add fagram.json
          git commit -m "Update scoop manifest to $RELEASE_TAG"
          git push
